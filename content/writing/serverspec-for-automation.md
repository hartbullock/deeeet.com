+++
date = "2015-03-17T16:16:17+09:00"
draft = true
title = "デプロイ自動化とServerspec"
+++

[Serverspec本](http://www.oreilly.co.jp/books/9784873117096/)の献本ありがとうございました．書評はすでに素晴らしい記事がいくつかあるので，僕は現チームでどのようにserverspecを導入したか，どのように使っているかについて書きたいと思う．

- Rubyが書けるひと，Rubyが書けないひと
- サーバーリストの管理
- 失敗したサーバーの保存
- 不安を取り除く
- ディレクトリ構成
- run.jsonによる共通化
- 通知する

## Serverspec導入の背景

今のチームではサーバーのセッアップおよびデプロイにChefを使っている．本書にも書かれているようにこのような構成管理ツールを使っている場合はそのツールを信頼するべきであり，Serverspecのようなテストツールは必要ない．僕らのチームもそのような理由でServerspecの導入には至っていなかった．

やがてアプリケーションが複雑になりChefのレシピが混沌としてくるとそれは成立しなくなる．見通しの悪いレシピはChefへの信頼度を落とす．信頼度の低下はデプロイ不信に繋がりやがて人手（筋肉）によるテストが始まる．

サーバーの数がそこまで多くなければなんとか運用できるかもしれない．しかしサーバーの数が膨大になるとデプロイ担当者が登場し，本来やるべき仕事が失われる．

このような状況を解決するためにServerspecを導入した．具体的には以下を行う．

- Chefレシピのリファクタリング
- デプロイ時の人手による確認作業の自動化

1つ目に関しては現在インフラCI環境の構築中でまだ成果は出ていない．2つ目のデプロイに関しては成果が出ているのでそちらについて工夫したことなどを簡単に書いておく．

## デプロイの3ステップ

Blue-Green以前のデプロイでは以下の3つのステップが必要になる．

1. サービスアウト
2. セットアップ
3. サービスイン

まず，**サービスアウト**ではサーバーのロードバランサからの切り離し，デーモン化したジョブの停止などを行いユーザ影響をなくす．このあたりはチームごとにやり方があると思う．APIを叩くかもしれないしLBが特定のファイルをチェックしているかもしれない．

次に，**セットアップ**ではChefなどを用いてミドルウェアのインストールやアプリケーションのアップデート，設定値の更新などを行う（冪等性！冪等性！）．

最後に，**サービスイン**では遮断したアクセスの復帰，デーモンジョブの再開を行いサーバーを本来のあるべき状態に戻す．

（各ステップに人手の作業が必要ないことが前提になるが）デプロイ自動化とはこれらのステップを一気に行うこととする．


## 通知

<img src="/images/hipchat-deploy.png" class="image">

サーバーの台数が多いとデプロイに時間がかかる．常にデプロイの様子を見ているわけにもいかない．ので問題があったとき，各ステップが無事終了したときにそれを通知として受け取れると良い．例えばHipChatの場合は以下のようなスクリプトを準備しておくと良い．

```bash
notify() {
  local USER=$1
  local MESSAGE=$2
    
  URL=https://api.hipchat.com/v2/room/${ROOM}/notification\?auth_token\=${TOKEN}
    
  JSON="{
    \"message_format\": \"text\",
    \"message\": \"@${USER} ${MESSAGE}\",
    \"notify\": true
  }"
    
  curl -X POST \
      -H "Content-Type: application/json" \
      -d "${JSON}" ${URL}
}
```

以下のように使う．

```bash
$ notify Taichi "Service out is done!"
```



