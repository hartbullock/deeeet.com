+++
date = "2015-08-31T15:53:58+09:00"
draft = true
title = "Apache Kafkaのメッセージング機構"
+++

メッセージはトピックというラベルをもとにやりとりされる．

メッセージはトピック>Broker>パーティション（ディレクトリ）> ログ（セグメントファイル）という階層で保存されている．トピックはBrokerをまたいで存在できる．Brokerはそれぞれプロセスとして存在しそれらが個々にログを保存する．パーティションはBrokerごとにのログデータをさらに分割して管理するための階層("トピック-パーティション"という名前でディレクトリが作成される)．そして受信したメッセージはファイルとして保存される．このファイルはセグメントファイルと呼ばれる．またBrokerはプロセス内部にセグメントリストを持っており、セグメントファイルの名前，開始オフセット，サイズ，作成時刻などを保持している．1つのセグメントファイルには複数のメッセージが記録される．

Brokerは最新のセグメントファイルの末尾にメッセージを追記するためパーティション単位で順序性は保証される．読み込みはトピックとパーティション番号とオフセット番号を元にセグメントリストを参照して対象のセグメントファイルを特定する．次に特定したセグメントファイルからオフセット以降のメッセージを読み込む．


Zookeeper連携．Brokerは起動時にホスト名とポート番号をZookeeperの`/brokers/ids/[BrokerId]`に登録する．これによりProducerやConsumerは`BrokerId`を元に接続するべきホスト名とポート番号を取得することができる．またBrokerは`/brokers/topics/[topic]/[BrokerId]`ノードを作成し自身がもつ`Topic`のパーティション数を登録する（e.g., `/broker/topics/topic1/0`，値2）これによりProducerとConsumerは対象の`Topic`から`BrokerId`とパーティションを決定することができる．これらの仕組みによりBrokerのスケールが簡単になる．Brokerが増減してもProducerやConsumerの設定ファイルを変更することなく配信/購読先を動的に変更できるようになる．

